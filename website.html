<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Saxo Margin Master & Explained</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #0f172a; color: #f8fafc; padding: 20px; line-height: 1.5; }
        .container { max-width: 1100px; margin: auto; background: #1e293b; padding: 25px; border-radius: 12px; border: 1px solid #334155; }
        
        /* Summary Metrics */
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; }
        .card { background: #0f172a; padding: 15px; border-radius: 8px; border: 1px solid #475569; text-align: center; }
        .card label { font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; font-weight: bold; }
        .usd-val { font-size: 1.5rem; font-weight: bold; display: block; margin-top: 5px; }
        .eur-val { font-size: 0.95rem; color: #38bdf8; }
        
        /* Inputs & Tables */
        .settings-bar { background: #1e293b; padding: 15px; border: 1px dashed #475569; border-radius: 8px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px; align-items: end; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 15px; background: #0f172a; border-radius: 8px; }
        th { text-align: left; padding: 10px; background: #334155; color: #cbd5e1; font-size: 0.7rem; text-transform: uppercase; }
        td { padding: 8px; border-bottom: 1px solid #334155; }
        input { background: #1e293b; border: 1px solid #475569; color: white; padding: 6px; border-radius: 4px; width: 85%; }

        /* Explanation Section */
        .info-box { background: #0f172a; border-left: 4px solid #38bdf8; padding: 20px; margin-top: 30px; border-radius: 0 8px 8px 0; font-size: 0.9rem; color: #cbd5e1; }
        .info-box h3 { margin-top: 0; color: #38bdf8; font-size: 1.1rem; }
        .formula { background: #1e293b; padding: 10px; border-radius: 4px; font-family: monospace; color: #fbbf24; margin: 10px 0; }

        .btn { padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; border: none; transition: 0.2s; }
        .btn-add { background: #38bdf8; color: #0f172a; margin-bottom: 20px; }
        .btn-util { background: #22c55e; color: #0f172a; }
        .remove { color: #f43f5e; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0; color: #38bdf8;">Saxo Portfolio & Margin Calculator</h2>
        <div>
            <input type="file" id="load-file" style="display: none;" onchange="loadPortfolio(this)">
            <button class="btn" style="background:#475569; color:white;" onclick="document.getElementById('load-file').click()">Load</button>
            <button class="btn btn-util" onclick="exportPortfolio()">Export .txt</button>
        </div>
    </div>

    <div class="summary-grid">
        <div class="card">
            <label>Collateral Value (Assets)</label>
            <span class="usd-val" id="collat-usd">$0</span>
            <span class="eur-val" id="collat-eur">€0</span>
        </div>
        <div class="card" style="border-color: #f43f5e;">
            <label>Margin Used (Liabilities)</label>
            <span class="usd-val" id="used-usd" style="color:#f43f5e">$0</span>
            <span class="eur-val" id="used-eur">€0</span>
        </div>
        <div class="card" style="border-color: #22c55e;">
            <label>Available Margin</label>
            <span class="usd-val" id="avail-usd" style="color:#22c55e">$0</span>
            <span id="avail-pct" style="font-weight:bold; color:#94a3b8;">100%</span>
        </div>
    </div>

    <div class="settings-bar">
        <div>
            <label style="font-size:0.7rem; color:#94a3b8;">CASH (USD)</label>
            <input type="number" id="cash-usd" value="50000" oninput="calculate()">
        </div>
        <div>
            <label style="font-size:0.7rem; color:#94a3b8;">CASH (EUR)</label>
            <input type="number" id="cash-eur" value="20000" oninput="calculate()">
        </div>
        <div>
            <label style="font-size:0.7rem; color:#94a3b8;">FX RATE (1 EUR = ? USD)</label>
            <input type="number" id="fx-rate" value="1.08" step="0.0001" oninput="calculate()">
        </div>
    </div>

    <h4 style="color:#94a3b8;">STOCKS (Fully Owned)</h4>
    <table id="stock-table">
        <thead>
            <tr><th>Ticker</th><th>Price</th><th>Qty</th><th>Collat %</th><th>Collat Val ($)</th><th></th></tr>
        </thead>
        <tbody></tbody>
    </table>
    <button class="btn btn-add" onclick="addStockRow()">+ Add Stock</button>

    <h4 style="color:#94a3b8;">SHORT PUTS (Naked)</h4>
    <table id="option-table">
        <thead>
            <tr><th>Ticker</th><th>Strike</th><th>Premium</th><th>Spot</th><th>Qty</th><th>Margin Req ($)</th><th></th></tr>
        </thead>
        <tbody></tbody>
    </table>
    <button class="btn btn-add" onclick="addOptionRow()">+ Add Short Put</button>

    <div class="info-box">
        <h3>How Saxo Calculates Your Margin</h3>
        <p>Your <strong>Available Margin</strong> is the difference between what your assets are worth as "loan security" and the risk of your open short positions.</p>
        
        <strong>1. Collateral (Your Power)</strong>
        <p>Saxo allows you to use your owned stocks as collateral instead of cash. Each stock has a rating (usually 1–6). 
           A Rating 1 stock typically provides <strong>75% collateral</strong>. 
           <br><em>Calculation:</em> (Stock Market Value × Collateral %) + Cash Balances = Total Collateral.</p>

        <strong>2. Short Put Margin (The "15% Rule")</strong>
        <p>Saxo uses a "Maintenance Margin" formula for naked puts to ensure you can cover a sharp drop:</p>
        <div class="formula">
            Margin = [Premium + Max( (15% × Spot) - OTM Amount, (10% × Strike) )] × 100 × Qty
        </div>
        <p>If the stock is deep <strong>Out-of-the-Money (OTM)</strong>, the requirement drops toward the 10% floor. As it goes <strong>In-the-Money (ITM)</strong>, the requirement increases rapidly.</p>
    </div>
</div>

<script>
function calculate() {
    const fxRate = parseFloat(document.getElementById('fx-rate').value) || 1;
    const cashUSD = parseFloat(document.getElementById('cash-usd').value) || 0;
    const cashEUR = (parseFloat(document.getElementById('cash-eur').value) || 0) * fxRate;
    
    let totalCollat = cashUSD + cashEUR;
    let totalUsed = 0;

    document.querySelectorAll("#stock-table tbody tr").forEach(row => {
        const p = parseFloat(row.querySelector(".price").value) || 0;
        const q = parseFloat(row.querySelector(".qty").value) || 0;
        const c = (parseFloat(row.querySelector(".collat").value) || 0) / 100;
        const val = (p * q) * c;
        row.querySelector(".res-col").innerText = "$" + val.toLocaleString();
        totalCollat += val;
    });

    document.querySelectorAll("#option-table tbody tr").forEach(row => {
        const s = parseFloat(row.querySelector(".strike").value) || 0;
        const pr = parseFloat(row.querySelector(".prem").value) || 0;
        const sp = parseFloat(row.querySelector(".u-price").value) || 0;
        const q = parseFloat(row.querySelector(".o-qty").value) || 0;
        
        const otm = Math.max(0, sp - s);
        const marginPerShare = pr + Math.max((0.15 * sp) - otm, (0.10 * s));
        const totalReq = marginPerShare * 100 * q;
        
        row.querySelector(".res-margin").innerText = "$" + totalReq.toLocaleString();
        totalUsed += totalReq;
    });

    const avail = Math.max(0, totalCollat - totalUsed);
    const pct = totalCollat > 0 ? (avail / totalCollat * 100).toFixed(1) : 0;

    document.getElementById("collat-usd").innerText = "$" + totalCollat.toLocaleString();
    document.getElementById("collat-eur").innerText = "€" + (totalCollat / fxRate).toLocaleString();
    document.getElementById("used-usd").innerText = "$" + totalUsed.toLocaleString();
    document.getElementById("used-eur").innerText = "€" + (totalUsed / fxRate).toLocaleString();
    document.getElementById("avail-usd").innerText = "$" + avail.toLocaleString();
    document.getElementById("avail-pct").innerText = pct + "% Available";
}

function addStockRow(d = ['NVDA', 130, 100, 75]) {
    const row = document.querySelector("#stock-table tbody").insertRow();
    row.innerHTML = `<td><input type="text" value="${d[0]}"></td><td><input type="number" class="price" value="${d[1]}" oninput="calculate()"></td><td><input type="number" class="qty" value="${d[2]}" oninput="calculate()"></td><td><input type="number" class="collat" value="${d[3]}" oninput="calculate()"></td><td class="res-col">$0</td><td class="remove" onclick="this.parentElement.remove();calculate()">×</td>`;
    calculate();
}

function addOptionRow(d = ['TSLA', 200, 5, 210, 1]) {
    const row = document.querySelector("#option-table tbody").insertRow();
    row.innerHTML = `<td><input type="text" value="${d[0]}"></td><td><input type="number" class="strike" value="${d[1]}" oninput="calculate()"></td><td><input type="number" class="prem" value="${d[2]}" oninput="calculate()"></td><td><input type="number" class="u-price" value="${d[3]}" oninput="calculate()"></td><td><input type="number" class="o-qty" value="${d[4]}" oninput="calculate()"></td><td class="res-margin">$0</td><td class="remove" onclick="this.parentElement.remove();calculate()">×</td>`;
    calculate();
}

function exportPortfolio() {
    let out = `CASH_USD|${document.getElementById('cash-usd').value}\nCASH_EUR|${document.getElementById('cash-eur').value}\nFX|${document.getElementById('fx-rate').value}\n`;
    document.querySelectorAll("#stock-table tbody tr").forEach(r => {
        out += "STOCK|" + Array.from(r.querySelectorAll("input")).map(i=>i.value).join("|") + "\n";
    });
    document.querySelectorAll("#option-table tbody tr").forEach(r => {
        out += "PUT|" + Array.from(r.querySelectorAll("input")).map(i=>i.value).join("|") + "\n";
    });
    const blob = new Blob([out], {type: 'text/plain'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = 'portfolio.txt'; a.click();
}

function loadPortfolio(input) {
    const reader = new FileReader();
    reader.onload = function() {
        const lines = reader.result.split('\n');
        document.querySelector("#stock-table tbody").innerHTML = "";
        document.querySelector("#option-table tbody").innerHTML = "";
        lines.forEach(l => {
            const p = l.split('|');
            if(p[0]==='CASH_USD') document.getElementById('cash-usd').value = p[1];
            if(p[0]==='CASH_EUR') document.getElementById('cash-eur').value = p[1];
            if(p[0]==='FX') document.getElementById('fx-rate').value = p[1];
            if(p[0]==='STOCK') addStockRow(p.slice(1));
            if(p[0]==='PUT') addOptionRow(p.slice(1));
        });
        calculate();
    };
    reader.readAsText(input.files[0]);
}

addStockRow(); addOptionRow();
</script>
</body>
</html>